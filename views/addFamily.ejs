<%- include('shared/header') %>

<style>
  .admin-family-form-container {
    background: white;
    max-width: 600px;
    margin: auto;
    padding: 20px;
  }

  .form-title {
    text-align: center;
    margin-bottom: 20px;
  }

  .admin-family-form .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 15px;
  }

  .admin-family-form label {
    margin-bottom: 5px;
    font-weight: bold;
  }

  .admin-family-form input,
  .admin-family-form select {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
  }

  .form-actions {
    text-align: center;
    margin-top: 20px;
  }

  .btn-primary {
    background: #007bff;
    border: none;
    padding: 12px 20px;
    color: #fff;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-primary:hover {
    background: #0056b3;
  }

  @media (max-width: 600px) {
    .admin-family-form-container {
      padding: 15px;
    }

    .admin-family-form .form-group {
      margin-bottom: 12px;
    }

    .admin-family-form input,
    .admin-family-form select {
      font-size: 16px;
      padding: 12px;
    }

    .btn-primary {
      width: 100%;
      padding: 14px;
      font-size: 18px;
    }
  }
</style>

<main class="admin-family-form-container">
  <h2 class="form-title">नया परिवार जोड़ें</h2>

  <div class="admin-family-form">
    <div id="family-fields">
      <div class="form-group">
        <label for="lineageName">वंश का नाम:</label>
        <input type="text" name="lineageName" id="lineageName">
      </div>

      <div class="form-group">
        <label for="clan">क्षत्रिय:</label>
        <input type="text" name="clan" id="clan">
      </div>

      <div class="form-group">
        <label for="adminBlockSelect">ब्लॉक:</label>
        <select name="block" id="adminBlockSelect">
          <option value="">-- ब्लॉक चुनें --</option>
          <option value="गौरा">गौरा</option>
        </select>
      </div>

      <div class="form-group">
        <label for="adminNyaySelect">न्याय पंचायत:</label>
        <select name="nyay" id="adminNyaySelect" disabled>
          <option value="">-- पहले ब्लॉक चुनें --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="adminVillageSelect">गांव:</label>
        <select name="village" id="adminVillageSelect" disabled>
          <option value="">-- पहले न्याय पंचायत चुनें --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="oldResidence">पूर्व निवास:</label>
        <input type="text" name="oldResidence" id="oldResidence">
      </div>

      <div class="form-actions">
        <button class="btn-primary" id="addFamilyBtn">Add Family</button>
      </div>
    </div>
  </div>
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const blockSelect = document.getElementById('adminBlockSelect');
    const nyaySelect = document.getElementById('adminNyaySelect');
    const villageSelect = document.getElementById('adminVillageSelect');
    const addFamilyBtn = document.getElementById('addFamilyBtn');

    const lineageName = document.getElementById('lineageName');
    const clan = document.getElementById('clan');
    const oldResidence = document.getElementById('oldResidence');

    const hierarchy = {
      "गौरा": {
        "सुल्तानपुर": ["सुल्तानपुर", "सुल्तानपुर कठार", "रिशालगढ़", "टिकैता", "अतरी", "जाजपुर", "बिरई पुर", "रामनगर", "दमदम", "घीनापुर", "बोर्रा"]
      }
    };

    blockSelect.addEventListener("change", () => {
      nyaySelect.innerHTML = '<option value="">-- न्याय पंचायत चुनें --</option>';
      villageSelect.innerHTML = '<option value="">-- पहले न्याय पंचायत चुनें --</option>';
      nyaySelect.disabled = true;
      villageSelect.disabled = true;

      const block = blockSelect.value;
      if (block && hierarchy[block]) {
        nyaySelect.disabled = false;
        Object.keys(hierarchy[block]).forEach(nyay => {
          const opt = document.createElement("option");
          opt.value = nyay;
          opt.textContent = nyay;
          nyaySelect.appendChild(opt);
        });
      }
    });

    nyaySelect.addEventListener("change", () => {
      villageSelect.innerHTML = '<option value="">-- गांव चुनें --</option>';
      villageSelect.disabled = true;

      const block = blockSelect.value;
      const nyay = nyaySelect.value;

      if (nyay && hierarchy[block][nyay]) {
        villageSelect.disabled = false;
        hierarchy[block][nyay].forEach(village => {
          const opt = document.createElement("option");
          opt.value = village;
          opt.textContent = village;
          villageSelect.appendChild(opt);
        });
      }
    });

    addFamilyBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      try {
        const res = await fetch("/family/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            lineageName: lineageName.value,
            clan: clan.value,
            village: villageSelect.value,
            nyayPanchayat: nyaySelect.value,
            block: blockSelect.value,
            oldResidence: oldResidence.value,
          }),
        });

        if (!res.ok) throw new Error("Failed to add family");

        const data = await res.json();
        alert(`✅ ${data.message}\nFamily Name: ${data.family.lineageName}`);
      } catch (err) {
        console.error(err);
        alert("❌ Error Adding Family");
      }
    });
  });
</script>

<%- include('shared/footer') %>