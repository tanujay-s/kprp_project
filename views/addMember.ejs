<%- include('shared/header') %>
<style>
  .search-results {
    border: 1px solid #ccc;
    max-height: 200px;
    overflow-y: auto;
    background: #fff;
    margin-top: 4px;
    border-radius: 5px;
  }

  .search-item {
    padding: 8px;
    cursor: pointer;
  }

  .search-item:hover {
    background: #f0f0f0;
  }
</style>

<main class="admin-member-form-container">
    <h2 class="form-title">Add Family / Member</h2>

    <div style="display: flex; align-items: center; justify-content: space-around;">
      <div class="form-group">
          <label><input type="radio" name="mode" value="family" checked> नया परिवार जोड़ें</label>
          <label><input type="radio" name="mode" value="member"> मौजूदा परिवार में सदस्य जोड़ें</label>
      </div>
    </div>

    <div class="admin-member-form">
        <div>
            <div id="family-fields">
                <div class="form-group">
                    <label for="lineageName">वंश का नाम:</label>
                    <input type="text" name="lineageName" id="lineageName">
                </div>
    
                <div class="form-group">
                    <label for="clan">क्षत्रिय:</label>
                    <input type="text" name="clan" id="clan">
                </div>
    
                <div class="form-group">
                    <label for="blockSelect">ब्लॉक:</label>
                    <select name="block" id="adminBlockSelect">
                      <option value="">-- ब्लॉक चुनें --</option>
                      <option value="गौरा">गौरा</option>
                    </select>
                </div>
    
                <div class="form-group">
                    <label for="nyaySelect">न्याय पंचायत:</label>
                    <select name="nyay" id="adminNyaySelect" disabled>
                        <option value="">-- पहले ब्लॉक चुनें --</option>
                    </select>
                </div>
    
                <div class="form-group">
                    <label for="villageSelect">गांव:</label>
                    <select name="village" id="adminVillageSelect" disabled >
                        <option value="">-- पहले न्याय पंचायत चुनें --</option>
                    </select>
                </div>
    
                <div class="form-group">
                    <label for="oldResidence">पूर्व निवास:</label>
                    <input type="text" name="oldResidence" id="oldResidence">
                </div>
                <div class="form-actions">
                    <button class="" id="addFamilyBtn">Add Family</button>
                </div>
            </div>
        </div>
        <div>
            <div id="member-fields" style="display:none;">
                <div class="form-group">
                    <label for="familySearch">परिवार खोजें:</label>
                    <input type="text" id="familySearch" placeholder="वंश/ग्राम से खोजें...">
                    <div id="searchResults" class="search-results"></div>
                </div>
    
                <input type="hidden" name="family_id" id="selectedFamilyId">
    
                <div class="form-group">
                    <label for="memberName">सदस्य का नाम:</label>
                    <input type="text" name="memberName" id="memberName">
                </div>

                <div class="form-group">
                    <label for="guardianName">पिता का नाम:</label>
                    <input type="text" name="guardianName" id="guardianName">
                </div>
    
                <div class="form-group">
                    <label for="otherDetails">अन्य:</label>
                    <input type="text" name="otherDetails" id="otherDetails">
                </div>

                <div class="form-group">
                  <label for="year">वर्ष:</label>
                  <input type="date" name="year" id="year">
                </div>
                
                <div class="form-group">
                  <label for="yearType">प्रकार चुनें:</label>
                  <select name="yearType" id="yearType">
                    <option value="birth">जन्म (DOB)</option>
                    <option value="death">मृत्यु (YOD)</option>
                  </select>
                </div>

                <div class="form-actions">
                    <button class="" id="addMemberBtn">Add Member</button>
                </div>
            </div>
        </div>
    </div>
</main>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const familyFields = document.getElementById("family-fields");
    const memberFields = document.getElementById("member-fields");
    const blockSelect = document.getElementById('adminBlockSelect');
    const nyaySelect = document.getElementById('adminNyaySelect');
    const villageSelect = document.getElementById('adminVillageSelect');
    const addFamilyBtn = document.getElementById('addFamilyBtn');
    const lineageName = document.getElementById('lineageName');
    const clan = document.getElementById('clan');
    const oldResidence = document.getElementById('oldResidence');
    const addMemberBtn = document.getElementById('addMemberBtn');
    const year = document.getElementById('year');
    const yearType = document.getElementById('yearType');
    const guardianName = document.getElementById('guardianName');
    const memberName = document.getElementById('memberName');
    const memberOtherDetails = document.getElementById('otherDetails');


    const hierarchy = {
      "गौरा": {
        "सुल्तानपुर": ["सुल्तानपुर", "सुल्तानपुर कठार", "रिशालगढ़", "टिकैता", "अतरी", "जाजपुर", "बिरई पुर", "रामनगर", "दमदम", "घीनापुर", "बोर्रा"]
      }
    };

    blockSelect.addEventListener("change", () => {
      nyaySelect.innerHTML = '<option value="">-- न्याय पंचायत चुनें --</option>';
      villageSelect.innerHTML = '<option value="">-- पहले न्याय पंचायत चुनें --</option>';
      nyaySelect.disabled = true;
      villageSelect.disabled = true;

      const block = blockSelect.value;
      if (block && hierarchy[block]) {
        nyaySelect.disabled = false;
        Object.keys(hierarchy[block]).forEach(nyay => {
          const opt = document.createElement("option");
          opt.value = nyay;
          opt.textContent = nyay;
          nyaySelect.appendChild(opt);
        });
      }
    });

    nyaySelect.addEventListener("change", () => {
      villageSelect.innerHTML = '<option value="">-- गांव चुनें --</option>';
      villageSelect.disabled = true;

      const block = blockSelect.value;
      const nyay = nyaySelect.value;

      if (nyay && hierarchy[block][nyay]) {
        villageSelect.disabled = false;
        hierarchy[block][nyay].forEach(village => {
          const opt = document.createElement("option");
          opt.value = village;
          opt.textContent = village;
          villageSelect.appendChild(opt);
        });
      }
    });

    // [blockSelect, nyaySelect, villageSelect].forEach(select => {
    //   select.addEventListener("change", () => {
    //     document.querySelector(".filter-btn").disabled =
    //       !blockSelect.value || !nyaySelect.value || !villageSelect.value;
    //   });
    // });

    document.querySelectorAll("input[name='mode']").forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "family") {
          familyFields.style.display = "block";
          memberFields.style.display = "none";
        } else {
          familyFields.style.display = "none";
          memberFields.style.display = "block";
        }
      });
    });

    const familySearch = document.getElementById("familySearch");
    const searchResults = document.getElementById("searchResults");
    const selectedFamilyId = document.getElementById("selectedFamilyId");

    familySearch?.addEventListener("input", async () => {
      const query = familySearch.value.trim();
      if (query.length < 2) {
        searchResults.innerHTML = "";
        return;
      }

      const res = await fetch(`/admin/search-family?q=${query}`);
      const families = await res.json();

      searchResults.innerHTML = families.map(fam => `
      <div class="search-item" data-id="${fam._id}">
        <strong>${fam.lineageName}</strong> (${fam.village})
      </div>
     `).join("");

      document.querySelectorAll(".search-item").forEach(item => {
        item.addEventListener("click", () => {
          selectedFamilyId.value = item.dataset.id;
          familySearch.value = item.innerText;
          searchResults.innerHTML = "";
        });
      });
    });

    addFamilyBtn.addEventListener("click", async ()=>{
      try{
        const res = await fetch("/family/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            lineageName: lineageName.value,
            clan: clan.value,
            village: villageSelect.value,
            nyayPanchayat: nyaySelect.value,
            block: blockSelect.value,
            oldResidence: oldResidence.value,
          }),
        });
        if(!res.ok){
          throw new Error("Failed to add family");
        }

        const data = await res.json();
        alert(`✅ ${data.message}\nFamily Name: ${data.family.lineageName}`);

      } catch (err){
        console.error(err);
        alert("❌ Error Adding Family");
      }
    });
    
    addMemberBtn.addEventListener("click", async () =>{
      try{
        const memberData = {
          family_id: document.getElementById("selectedFamilyId").value,
          memberName: document.getElementById("memberName").value,
          guardianName: document.getElementById("guardianName").value,
          otherDetails: document.getElementById("otherDetails").value,
        };

        if (year) {
          memberData.year = year;
          memberData.yearType = yearType;
        }
        const res = await fetch("/member/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(memberData), 
        });

        if(!res.ok){
          throw new Error("Failed to add member");
        }

        const data = await res.json();
        alert(`✅ ${data.message}\nMember Name: ${data.member.name}`);

      } catch (err){
        console.error(err);
        alert("❌ Error Adding Member");
      }
    });

  });
</script>

<%- include('shared/footer') %>
